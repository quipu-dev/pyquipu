# 🧠 核心概念

理解 Axon 的核心在于理解它是如何解析指令以及如何管理状态的。

## 1. 协议：Act 与 Context

Axon 将操作分解为两个原语：

*   **Act (动词)**: 定义要做什么（例如：写入文件、提交代码）。
*   **Context (名词)**: 提供操作所需的参数（例如：文件路径、代码内容）。

这种结构天然契合 Markdown 的代码块语法：

````markdown
~~~act
write_file      <-- Act
~~~
~~~path
main.py         <-- Context 1
~~~
~~~content
print("Hi")     <-- Context 2
~~~
````

## 2. 参数解析模式 (ArgMode)

为了平衡灵活性与严谨性，不同的 Act 使用不同的参数解析策略：

| 模式 | 描述 | 适用指令示例 |
| :--- | :--- | :--- |
| **Hybrid (混合模式)** | **贪婪合并**。既读取 `act` 行内的参数，也读取后续的代码块。 | `write_file`, `replace` |
| **Exclusive (互斥模式)** | **优先行内**。如果行内有参数，则忽略后续代码块；否则读取代码块。 | `git_add`, `run_command` |
| **Block Only (仅块模式)** | **严格模式**。强制忽略行内参数，只读取代码块。常用于防止 AI 乱写参数。 | `git_commit` |

## 3. 智能幕布 (Smart Parsers)

Axon 支持多种围栏符号，以便在文档中嵌套代码块时互不干扰：

*   **绿幕模式**：使用 ` ```act `。适用于普通文本指令。
*   **蓝幕模式**：使用 ` ~~~act `。适用于指令内容中包含反引号（如 Python 代码）的情况。
*   **变长围栏**：支持 `~~~~~act` 或 ` `````act `，只要围栏长度大于等于 3 且首尾匹配即可。

## 4. 幽灵状态引擎 (Phantom State Engine)

Axon v4.2 引入了革命性的状态管理机制：

*   **State is Truth**: Axon 不维护额外的数据库来记录“当前在哪”。它通过计算当前工作区的 **Git Tree Hash** 来定位。
*   **Lazy Capture**: 在执行新指令前，如果发现环境与历史记录不一致（比如用户手动改了代码），Axon 会自动生成一个 **Capture Node** 来保存当前状态。这意味着你永远不用担心 Axon 会覆盖你未保存的工作。
*   **历史即图谱 (History as a DAG)**: Axon 的历史记录不是一条直线，而是一个**有向无环图 (DAG)**。当你 `checkout` 到一个旧节点并执行新的 Plan 时，就会创建出一个新的分支。这使得无损实验和多方案探索成为可能，也是 `undo`, `redo`, `prev`, `next` 等导航命令的基础。