# chore: åˆ›å»ºä¸€ä¸ªæ¸…ç† Git å†å²çš„è„šæœ¬

## ç”¨æˆ·éœ€æ±‚
`quipu history migrate` å‘½ä»¤å½“å‰ä¸æ˜¯å¹‚ç­‰çš„ï¼Œå¤šæ¬¡è¿è¡Œä¼šåœ¨ Git æ•°æ®åº“ä¸­åˆ›å»ºé‡å¤çš„å†å²è®°å½•ã€‚ä¸ºäº†èƒ½åœ¨å¹²å‡€çš„çŠ¶æ€ä¸‹é‡æ–°è¿è¡Œè¿ç§»ï¼Œéœ€è¦ä¸€ä¸ªå·¥å…·æ¥å½»åº•æ¸…é™¤æ‰€æœ‰ç”± Quipu åœ¨ Git ä¸­ç”Ÿæˆçš„å†å²æ•°æ®ã€‚

## è¯„è®º
è¿™æ˜¯ä¸€ä¸ªåˆç†çš„ä¸´æ—¶è§£å†³æ–¹æ¡ˆã€‚ä¸å…¶åœ¨ä¸€æ¬¡æ€§è¿ç§»è„šæœ¬ä¸ŠæŠ•å…¥è¿‡å¤šç²¾åŠ›å»å®ç°å®Œç¾çš„å¹‚ç­‰æ€§ï¼Œä¸å¦‚æä¾›ä¸€ä¸ªç®€å•ã€å¯é çš„â€œé‡ç½®â€å·¥å…·ï¼Œè¿™æ›´ç¬¦åˆæˆæœ¬æ•ˆç›Šã€‚

## ç›®æ ‡
1.  åˆ›å»ºä¸€ä¸ªåä¸º `clear_quipu_refs.sh` çš„å¯æ‰§è¡Œ shell è„šæœ¬ã€‚
2.  è¯¥è„šæœ¬èƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹å¹¶åˆ é™¤å½“å‰ Git ä»“åº“ä¸­æ‰€æœ‰ `refs/quipu/*` å‘½åç©ºé—´ä¸‹çš„å¼•ç”¨ã€‚
3.  è„šæœ¬åœ¨æ‰§è¡Œå‰ä¼šå‘ç”¨æˆ·ç¡®è®¤å°†è¦åˆ é™¤çš„å†…å®¹ã€‚
4.  è„šæœ¬ä¸ä¼šè§¦åŠç”¨æˆ·çš„ä»£ç æäº¤å†å² (`refs/heads/*`) æˆ–æ—§çš„æ–‡ä»¶ç³»ç»Ÿå†å² (`.quipu/history/`)ã€‚

## åŸºæœ¬åŸç†
Quipu çš„æ–°å­˜å‚¨æœºåˆ¶ (QDPS v1.0) å°†æ‰€æœ‰å†å²èŠ‚ç‚¹ä½œä¸º Git Commit å¯¹è±¡è¿›è¡Œå­˜å‚¨ï¼Œå¹¶é€šè¿‡ç‰¹æ®Šçš„ Git å¼•ç”¨ (Refs) æ¥è¿½è¸ªå®ƒä»¬ï¼Œä»¥é˜²æ­¢è¢«åƒåœ¾å›æ”¶ã€‚è¿™äº›å¼•ç”¨éƒ½å­˜æ”¾åœ¨ `refs/quipu/` å‘½åç©ºé—´ä¸‹ (ä¾‹å¦‚ `refs/quipu/history` å’Œ `refs/quipu/heads/*`)ã€‚

å› æ­¤ï¼Œè¦å½»åº•æ¸…é™¤ Quipu çš„ Git å†å²ï¼Œæœ€å®‰å…¨å’Œæœ€æœ‰æ•ˆçš„æ–¹æ³•å°±æ˜¯åˆ é™¤è¿™ä¸ªå‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰å¼•ç”¨ã€‚è¿™ä¼šè®©ç›¸å…³çš„ Commit å¯¹è±¡å˜æˆâ€œæ‚¬ç©ºâ€çŠ¶æ€ï¼ŒGit çš„åƒåœ¾å›æ”¶æœºåˆ¶ (`git gc`) ä¼šåœ¨æœªæ¥æŸä¸ªæ—¶é—´ç‚¹è‡ªåŠ¨æ¸…ç†å®ƒä»¬ã€‚è¿™ä¸ªæ“ä½œä¸ä¼šå½±å“é¡¹ç›®çš„ä¸»åˆ†æ”¯æˆ–ä»»ä½•å…¶ä»–ç”¨æˆ·åˆ›å»ºçš„åˆ†æ”¯ã€‚

## æ ‡ç­¾
#comp/cli #comp/engine #concept/history #scope/dx

---

## Script

### Acts 1: åˆ›å»ºæ¸…ç†è„šæœ¬å¹¶èµ‹äºˆæ‰§è¡Œæƒé™

è¿™ä¸ªæ“ä½œå°†åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º `clear_quipu_refs.sh` æ–‡ä»¶ï¼Œå¹¶ä½¿å…¶å¯æ‰§è¡Œã€‚

~~~~~act
write_file
~~~~~

~~~~~path
clear_quipu_refs.sh
~~~~~

~~~~~bash
#!/bin/sh
set -e

# æ£€æŸ¥å½“å‰ç›®å½•æ˜¯å¦ä¸º Git ä»“åº“
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "é”™è¯¯: å½“å‰ç›®å½•ä¸æ˜¯ä¸€ä¸ª Git ä»“åº“ã€‚"
    exit 1
fi

echo "ğŸ” æ­£åœ¨æŸ¥æ‰¾æ‰€æœ‰ Quipu Git å¼•ç”¨ (refs/quipu/*)..."

# æŸ¥æ‰¾æ‰€æœ‰åœ¨ refs/quipu/ å‘½åç©ºé—´ä¸‹çš„å¼•ç”¨
QUIPU_REFS=$(git for-each-ref --format='%(refname)' refs/quipu/)

if [ -z "$QUIPU_REFS" ]; then
    echo "âœ… æœªæ‰¾åˆ°ä»»ä½• Quipu å¼•ç”¨ï¼Œæ— éœ€æ¸…ç†ã€‚"
    exit 0
fi

echo "ğŸ—‘ï¸  å³å°†åˆ é™¤ä»¥ä¸‹ Quipu å¼•ç”¨:"
echo "$QUIPU_REFS"
echo ""

# ä½¿ç”¨ xargs å®‰å…¨åœ°åˆ é™¤æ‰€æœ‰æ‰¾åˆ°çš„å¼•ç”¨
# -r: å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œåˆ™ä¸æ‰§è¡Œå‘½ä»¤
# -n 1: æ¯æ¬¡å¤„ç†ä¸€ä¸ªå‚æ•°
echo "$QUIPU_REFS" | xargs -r -n 1 git update-ref -d

echo "\nâœ… æ‰€æœ‰ Quipu Git å¼•ç”¨å·²æˆåŠŸåˆ é™¤ã€‚"
echo "ğŸ’¡ ä½ ç°åœ¨å¯ä»¥é‡æ–°è¿è¡Œ 'quipu history migrate'ã€‚ Git çš„åƒåœ¾å›æ”¶ (gc) å°†åœ¨æœªæ¥è‡ªåŠ¨æ¸…ç†æ— ç”¨çš„å¯¹è±¡ã€‚"

~~~~~

~~~~~act
run_command
~~~~~

~~~~~shell
chmod +x clear_quipu_refs.sh
~~~~~