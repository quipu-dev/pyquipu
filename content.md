太棒了！我们一起完成了一次相当深入的调试和修复。现在，让我们将这些成果固化到版本历史中。

这次提交将包含自上次提交以来我们进行的所有修复，这是一个连贯的整体，彻底解决了 UI 中历史图谱的渲染问题。

首先，将所有修改过的文件添加到暂存区。

~~~~~act
git_add core/history.py main.py ui/tui.py
~~~~~

然后，创建一次详细的提交，记录我们解决的全部问题。

~~~~~act
git_commit
~~~~~

~~~~~commit_message
fix(ui): 修复复杂历史图谱（含幂等节点）的渲染逻辑

本次提交解决了一系列导致 `axon ui` 在处理复杂历史（尤其是包含幂等节点时）崩溃或渲染不正确的问题。

这是一次完整的修复，包含以下关键变更：

1.  **`core/history.py` 重构**: 彻底修改了历史加载逻辑。
    *   问题：之前使用 `output_tree` 作为节点的唯一标识，导致幂等节点会覆盖其父节点，造成历史链断裂。
    *   修复：现在加载并连接**所有**的历史事件（`AxonNode`），即使它们共享同一个状态哈希，从而在内存中构建出完整的、正确的图谱。

2.  **`main.py` 更新**: `ui` 命令现在调用新的全量加载函数 (`load_all_history_nodes`)，确保 TUI 渲染器获得完整的数据源。

3.  **`ui/tui.py` 健壮性修复**:
    *   **唯一键**: 使用每个节点唯一的文件名（包含时间戳）作为 `DataTable` 的行 `key`，彻底解决了因 `output_tree` 重复导致的 `DuplicateKey` 崩溃。
    *   **渲染安全**: 修正了 Textual/Rich 的 Markup 标签嵌套逻辑，通过先构建内部有色文本再用 `[dim]` 包裹的方式，解决了 `MarkupError` 渲染错误。

经过这些修复，`axon ui` 现在能够稳定、正确地渲染任何复杂的历史分支和幂等节点序列。
~~~~~